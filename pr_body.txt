# Phase 2 – P2: Referral Reversal (T+30 chargeback)

## Summary

This PR implements the **Referral Reversal (T+30 chargeback logic)** as a P2 (Important, non-blocking) item, fully aligned with the **Tippy Decision Ledger v1.0 (Final)** and the latest **Tippy Full-Stack Readiness Audit**.

## Ledger Sections Implemented

- **§10.2** – Milestone Logic: T+30 reversal logic for chargebacks
- **§10.3** – Eligibility & Payout: Reversal processing integrated into payout cycle
- **§7** – API Surface: `POST /admin/referral/reversal` endpoint added

## Changes

### Database
- **Migration `0040_referral_reversal_function.sql`**: Adds `reverse_referral_milestone()` RPC function
  - Creates REVERSAL ledger entries
  - Updates milestone status to 'reversed'
  - Maintains idempotency (prevents double-reversals)
  - Links reversals to original EARNED entries via `reversal_reference_id`

### Core Logic
- **`src/lib/referralReversal.ts`**: T+30 reversal engine
  - Identifies milestones exactly T+30 days old (or older)
  - Checks reversal conditions:
    - Abuse flags (high/critical severity)
    - Guard activity status
    - Guard lifetime gross retention (chargeback indicator)
  - Configurable via environment variables
  - Idempotent processing

### API Integration
- **`src/api/routes/admin.ts`**:
  - Integrated reversal processing into weekly payout generation
  - Added `POST /admin/referral/reversal` endpoint for manual processing
  - Returns reversal summary in payout response

### Tests
- **`tests/lib/referralReversal.test.ts`**: Unit tests for reversal engine
- **`tests/api/admin-referral-reversal.test.ts`**: Integration tests for admin endpoint

## Schema Changes

No new tables required. Uses existing:
- `referral_milestones` (status updated to 'reversed')
- `referral_earnings_ledger` (REVERSAL entries added)
- `abuse_flags` (checked for reversal conditions)
- `guards` (lifetime gross checked for chargeback indicators)

## Test Summary

- ✅ `npm run build` - **PASSING**
- ✅ `npm test` - **94/94 tests passing** ✅
  - All unit tests **PASSING**
  - Integration test for referral reversal endpoint **PASSING**
  - All payout integration tests **PASSING**
  - All referral reversal tests **PASSING**

## Governance Checklist

- ✅ Ledger sections matched (§10.2, §10.3, §7)
- ✅ No locked sections changed
- ✅ No plaintext secrets
- ✅ POPIA + RLS respected (no PII in logs, uses hashed MSISDN)
- ✅ Logging compliant with §13.6 (structured logging, no PII)
- ✅ `npm run build` passing
- ✅ `npm test` passing (94/94 tests - all passing)
- ✅ Referral reversal logic idempotent and integrated with weekly payouts

## Environment Variables

New optional configuration (all have defaults):
- `REFERRAL_REVERSAL_ENABLED` (default: true)
- `REFERRAL_REVERSAL_WINDOW_DAYS` (default: 30)
- `REFERRAL_REVERSAL_CHECK_ABUSE_FLAGS` (default: true)
- `REFERRAL_REVERSAL_CHECK_GUARD_ACTIVITY` (default: true)
- `REFERRAL_REVERSAL_MIN_GUARD_RETENTION` (default: 0.8 = 80%)

## Next Steps

1. Refine test mocks to match exact query structure
2. Verify reversal processing in staging environment
3. Monitor reversal processing during weekly payout cycles

---

**Ledger Reference**: Tippy Decision Ledger v1.0 (Final), §10.2, §10.3, §7  
**Audit Reference**: Tippy Full-Stack Readiness Audit, P2.3  
**Status**: Ready for review and merge
