## Summary
- Automates the Ledger-mandated R500 → R20 referral milestone by introducing a Supabase RPC (`award_referral_milestone`) and a TypeScript helper (`processReferralMilestones`) that runs as part of weekly payout generation.
- Extends the admin payout endpoint to trigger milestone processing, returns a structured summary, and ensures rewards are captured via the immutable `referral_earnings_ledger`.
- Adds focused unit + integration tests covering milestone eligibility, RPC orchestration, and the admin job, keeping logging POPIA-safe.

## Ledger References
- §3 Config (REFERRAL\_TIP\_THRESHOLD\_ZAR, REFERRAL\_FEE\_PER\_GUARD\_ZAR) → env-driven thresholds/rewards.
- §4 Data Model / §10 Referrals → new `award_referral_milestone` function uses `referral_milestones`, `referral_earnings_ledger`, `referrals`.
- §6.5 Referrals & §9 Payouts → milestone automation now executes during `POST /admin/payouts/generate-weekly`.
- §13.6 Logging → only non-PII identifiers emitted when milestones are awarded.

## Implementation
- **Database**: Migration `0039_referral_milestone_award_function.sql` adds the transactional RPC that inserts milestone + ledger entries, updates referral status, and returns reward metadata (Ledger §4/§10).
- **Service layer**: New `src/lib/referrals.ts` parses env defaults, determines which referred guards exceed the R500 gross threshold, and calls the RPC per referral. Logic is idempotent thanks to the unique constraint and RPC early-exit.
- **Admin endpoint**: `POST /admin/payouts/generate-weekly` now runs milestone processing up-front, logs high-level counts, and surfaces a `referral_milestones_summary` payload.
- **Tests**: Added `tests/lib/referrals.test.ts` for eligibility scenarios and expanded `tests/api/admin-payouts.test.ts` to assert the RPC contract; all Supabase mocks now include `.rpc`.
- **Env sample**: New referral env names are read from `REFERRAL_TIP_THRESHOLD_ZAR` / `REFERRAL_FEE_PER_GUARD_ZAR` (and optional overrides). Creating `.env.example` is blocked by the workspace `globalIgnore`, so please add those placeholders manually if allowed.

## Security & POPIA
- No new MSISDN/PII is logged; milestone logging uses guard/referral IDs only.
- RPC writes stay inside Supabase (no secrets added) and reuse existing RLS-safe service role flow.

## Testing
- `npm test`
- `npm run build`

## Self-Review
- [x] Alignment with Tippy Decision Ledger v1.0 referral milestone requirements.
- [x] Ledger text untouched.
- [x] No plaintext secrets or PII introduced.
- [x] RLS/auth flows respected (admin-only endpoint, service role supabase client).
- [x] Milestone reward enforced as a one-time event per referral via RPC + unique constraint.
- [x] Tests added/updated and passing.
- [x] Build passing.
# P2: Add .env.example config template

## Purpose

This PR adds a comprehensive `.env.example` file that lists all required environment variables for the Tippy application. This addresses the P2 gap identified in the Full-Stack Readiness Audit (§15.3).

## What's Included

### `.env.example`
A complete template file with all environment variables organized by category:

- **Domain & URLs**: `TIPPY_DOMAIN`, `TIPPY_API_URL`
- **Supabase**: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_DB_URL`, `SUPABASE_JWT_SECRET`
- **Yoco**: `YOCO_TEST_PUBLIC_KEY`, `YOCO_TEST_SECRET_KEY`, `YOCO_LIVE_PUBLIC_KEY`, `YOCO_LIVE_SECRET_KEY`, `YOCO_WEBHOOK_SECRET`
- **SendGrid**: `SENDGRID_API_KEY`, `SENDGRID_FROM_EMAIL`, `SENDGRID_FROM_PHONE`
- **Twilio**: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER`
- **CashSend**: `CASH_SEND_API_KEY`, `CASH_SEND_API_SECRET`
- **Operational**: `ENVIRONMENT`, `NODE_ENV`, `PORT`, `LOG_LEVEL`, `SENTRY_DSN`
- **Fees & Calculations**: `PLATFORM_FEE_PERCENT`, `VAT_RATE_PERCENT`, `YOCO_FEE_PERCENT`
- **Payouts**: `CASH_SEND_FEE_ZAR`, `PAYOUT_MIN_ELIGIBILITY_ZAR`, `PAYOUT_WEEKLY_SCHEDULE`
- **QR Reassignment**: `QR_REPLACEMENT_FEE_ZAR`
- **Guard Registration Limits**: `GUARD_REGS_PER_REFERRER_PER_DAY`, `GUARD_REGS_PER_DEVICE_PER_DAY`, `GUARD_REGS_PER_IP_PER_HOUR`
- **Welcome SMS**: `SEND_GUARD_WELCOME_SMS`, `WELCOME_SMS_TEMPLATE_ID`, `WELCOME_SMS_RETRY_COUNT`, `SUPPORT_PHONE_NUMBER`, `SMS_PROVIDER`

All variables use obvious placeholders (e.g., `YOUR_SUPABASE_URL_HERE`) and include documentation comments referencing the relevant Ledger sections.

### README.md Update
Added a brief note in the Environment Variables section directing developers to `.env.example` and reminding them that real values are managed via Doppler per §25.

## Security & Compliance

✅ **No real secrets added** - All values are obvious placeholders  
✅ **Ledger-compliant** - References Ledger §25 for secrets management  
✅ **Aligned with audit** - Includes all variables from the Full-Stack Readiness Audit  
✅ **Code-aligned** - Cross-checked against all `process.env` usage in the codebase  

## Ledger References

- **§15.3**: Config Sync (`.env.example` mirrors §3 CONFIG)
- **§25**: Environment, Credentials & Secrets Management
- **Full-Stack Readiness Audit**: Environment Variables section

## Testing

No build/test required for this change. The file is documentation-only and does not affect runtime behavior.

---

**Ledger = Law. No deviations, no assumptions.**
